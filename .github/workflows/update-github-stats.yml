name: Generate GitHub Stats

on:
  schedule:
    - cron: '0 0 * * *'  # Runs at midnight every day
  workflow_dispatch:  # Allows manual triggering

jobs:
  generate-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          
      - name: Generate GitHub stats as comment
        run: |
          # Get the stats
          python -c "
          import requests
          import json
          import os
          
          # Get GitHub username and token
          username = os.environ.get('GITHUB_USERNAME', 'zakaBouj')
          token = os.environ.get('GITHUB_TOKEN', '')
          
          # Function to make API requests
          def github_api_request(url):
              headers = {'Authorization': f'token {token}'} if token else {}
              response = requests.get(url, headers=headers)
              if response.status_code == 200:
                  return response.json()
              return None
          
          # Get basic stats
          user_data = github_api_request(f'https://api.github.com/users/{username}')
          if not user_data:
              user_data = {'public_repos': 0, 'followers': 0}
              
          # Get stars
          stars = 0
          repos = github_api_request(f'https://api.github.com/users/{username}/repos?per_page=100')
          if repos:
              stars = sum(repo['stargazers_count'] for repo in repos)
          
          # Get total commits (estimated)
          commits = 0
          if repos:
              for repo in repos[:5]:  # Limit to 5 repos to avoid rate limits
                  repo_name = repo['name']
                  commits_data = github_api_request(f'https://api.github.com/repos/{username}/{repo_name}/commits?author={username}&per_page=1')
                  if commits_data and 'link' in requests.get(f'https://api.github.com/repos/{username}/{repo_name}/commits?author={username}&per_page=1', headers={'Authorization': f'token {token}'} if token else {}).headers:
                      link = requests.get(f'https://api.github.com/repos/{username}/{repo_name}/commits?author={username}&per_page=1', headers={'Authorization': f'token {token}'} if token else {}).headers['link']
                      if 'rel=\"last\"' in link:
                          commits += int(link.split('page=')[1].split('>')[0])
          
          # Create markdown for stats
          stats = f'''
          ## GitHub Stats (updated: {os.environ.get('GITHUB_RUN_ID', 'locally')})
          
          ![Repositories](https://img.shields.io/badge/Repositories-{user_data['public_repos']}-blue?style=flat&logo=github)
          ![Stars](https://img.shields.io/badge/Stars-{stars}-yellow?style=flat&logo=github)
          ![Followers](https://img.shields.io/badge/Followers-{user_data['followers']}-lightgrey?style=flat&logo=github)
          
          ![Total Commits](https://img.shields.io/badge/Total%20Commits-{commits}+-brightgreen?style=flat&logo=git)
          '''
          
          # Print the stats to be captured by GitHub Actions
          print(stats)
          "
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
        id: stats
        
      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const stats = process.env.STATS;
            if (!stats) {
              console.log('No stats generated');
              return;
            }
            
            // Create a comment on the latest commit
            const context = github.context;
            const repo = context.repo;
            
            github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number || 1,
              body: stats
            }).catch(e => {
              console.log('Could not post comment: ', e);
              
              // Post stats as workflow output
              console.log('GitHub Stats (copy to your README.md):');
              console.log(stats);
            });
        env:
          STATS: ${{ steps.stats.outputs.stdout }}